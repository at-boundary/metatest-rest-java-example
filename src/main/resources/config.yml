version: "1.0"

# Global settings
settings:
  default_quantifier: all
  # Skip fault simulation once any test catches it (useful for quick/smoke runs)
  # Set to true for faster runs, false for complete coverage information
  stop_on_first_catch: false

  # Endpoint-specific relation rules
endpoints:

  # ============================================================
  # ORDERS
  # ============================================================

  /api/v1/orders/{id}:
    GET:
      invariants:
        # Order status determines filled_at presence
        - name: filled_order_has_filled_at
          if:
            field: status
            equals: FILLED
          then:
            field: filled_at
            is_not_null: true

        - name: pending_order_no_filled_at
          if:
            field: status
            equals: PENDING
          then:
            field: filled_at
            is_null: true

        # Rejected orders must have rejection reason
        - name: rejected_order_has_reason
          if:
            field: status
            equals: REJECTED
          then:
            field: rejection_reason
            is_not_null: true

        - name: non_rejected_order_no_reason
          if:
            field: status
            not_equals: REJECTED
          then:
            field: rejection_reason
            is_null: true

        # Order type must be valid
        - name: valid_order_type
          field: order_type
          in: [ BUY, SELL ]

        # Quantity must be positive
        - name: positive_quantity
          field: quantity
          greater_than: 0

        # Price must be non-negative
        - name: non_negative_price
          field: price
          greater_than_or_equal: 0

        # Total amount must be non-negative
        - name: non_negative_total
          field: total_amount
          greater_than_or_equal: 0

        # Date ordering: created_at <= filled_at (when filled)
        - name: filled_at_after_created_at
          if:
            field: filled_at
            is_not_null: true
          then:
            field: created_at
            less_than_or_equal: $.filled_at

  /api/v1/orders:
    GET:
      invariants:
        # All orders in list must have valid status
        - name: all_orders_valid_status
          field: $[*].status
          in: [ PENDING, FILLED, REJECTED, CANCELLED ]

        # All orders must have positive quantity
        - name: all_orders_positive_quantity
          field: $[*].quantity
          greater_than: 0

    POST:
      invariants:
        # Created order should be PENDING or FILLED or REJECTED
        - name: new_order_valid_status
          field: status
          in: [ PENDING, FILLED, REJECTED ]

  # ============================================================
  # ACCOUNTS
  # ============================================================

  /api/v1/accounts/{id}:
    GET:
      invariants:
        # Cash balance must be non-negative
        - name: non_negative_cash
          field: cash_balance
          greater_than_or_equal: 0

        # Total value must be non-negative
        - name: non_negative_total_value
          field: total_value
          greater_than_or_equal: 0

        # Status must be valid
        - name: valid_account_status
          field: status
          in: [ ACTIVE, SUSPENDED, CLOSED ]

        # Date ordering
        - name: updated_after_created
          field: created_at
          less_than_or_equal: $.updated_at

        # Account number must not be empty
        - name: account_number_present
          field: account_number
          is_not_empty: true

        # Holder name must not be empty
        - name: holder_name_present
          field: holder_name
          is_not_empty: true

  /api/v1/accounts/{id}/performance:
    GET:
      invariants:
        # All counts must be non-negative
        - name: non_negative_positions_count
          field: positions_count
          greater_than_or_equal: 0

        - name: non_negative_trades_count
          field: trades_count
          greater_than_or_equal: 0

        # Cash balance non-negative
        - name: non_negative_perf_cash
          field: cash_balance
          greater_than_or_equal: 0

        # Position value non-negative
        - name: non_negative_position_value
          field: total_position_value
          greater_than_or_equal: 0

        # If no positions, position value should be 0
        - name: no_positions_zero_value
          if:
            field: positions_count
            equals: 0
          then:
            field: total_position_value
            equals: 0

        # If no positions, unrealized PnL should be 0
        - name: no_positions_zero_unrealized
          if:
            field: positions_count
            equals: 0
          then:
            field: total_unrealized_pnl
            equals: 0

  /api/v1/accounts/{id}/deposit:
    POST:
      invariants:
        # After deposit, cash should be positive
        - name: positive_cash_after_deposit
          field: cash_balance
          greater_than: 0

  /api/v1/accounts/{id}/withdraw:
    POST:
      invariants:
        # After withdrawal, cash should be non-negative
        - name: non_negative_cash_after_withdraw
          field: cash_balance
          greater_than_or_equal: 0

  # ============================================================
  # POSITIONS
  # ============================================================

  /api/v1/positions:
    GET:
      invariants:
        # All positions must have positive quantity
        - name: all_positions_positive_qty
          field: $[*].quantity
          greater_than: 0

        # All positions must have positive average cost
        - name: all_positions_positive_cost
          field: $[*].average_cost
          greater_than: 0

        # Symbol must not be empty
        - name: all_positions_have_symbol
          field: $[*].symbol
          is_not_empty: true

  /api/v1/positions/{id}:
    GET:
      invariants:
        # All positions for account must have matching account_id
        # (This tests data consistency)
        - name: all_positions_correct_account
          field: $[*].account_id
          # Note: Would need path parameter reference here
          # For now, just check it's positive
          greater_than: 0

        # Date ordering for each position
        - name: position_updated_after_created
          field: $[*].created_at
          less_than_or_equal: $[*].updated_at
          quantifier: all

  # ============================================================
  # TRADES
  # ============================================================

  /api/v1/trades:
    GET:
      invariants:
        # All trades must have valid trade type
        - name: all_trades_valid_type
          field: $[*].trade_type
          in: [ BUY, SELL ]

        # All trades must have positive quantity
        - name: all_trades_positive_qty
          field: $[*].quantity
          greater_than: 0

        # All trades must have positive price
        - name: all_trades_positive_price
          field: $[*].price
          greater_than: 0

        # All trades must have positive total
        - name: all_trades_positive_total
          field: $[*].total_amount
          greater_than: 0

  /api/v1/trades/{id}:
    GET:
      invariants:
        # Same as above for account-specific trades
        - name: account_trades_valid_type
          field: $[*].trade_type
          in: [ BUY, SELL ]

        - name: account_trades_positive_qty
          field: $[*].quantity
          greater_than: 0

  # ============================================================
  # STOCKS
  # ============================================================

  /api/v1/stocks:
    GET:
      invariants:
        # All stocks must have positive price
        - name: all_stocks_positive_price
          field: $[*].current_price
          greater_than: 0

        # All stocks must have non-empty symbol
        - name: all_stocks_have_symbol
          field: $[*].symbol
          is_not_empty: true

  /api/v1/stocks/{id}:
    GET:
      invariants:
        # Price must be positive
        - name: stock_positive_price
          field: current_price
          greater_than: 0

        # Symbol must not be empty
        - name: stock_symbol_present
          field: symbol
          is_not_empty: true

    PUT:
      invariants:
        # Updated price must be positive
        - name: updated_price_positive
          field: current_price
          greater_than: 0

  # ============================================================
  # AUTHENTICATION
  # ============================================================

  /api/v1/auth/login:
    POST:
      invariants:
        # Token must not be empty
        - name: token_present
          field: access_token
          is_not_empty: true

        # Token type should be Bearer
        - name: token_type_bearer
          field: token_type
          equals: bearer

  /api/v1/auth/register:
    POST:
      invariants:
        # User must be active after registration
        - name: new_user_active
          field: is_active
          equals: true

        # Email must not be empty
        - name: user_email_present
          field: email
          is_not_empty: true

        # Username must not be empty
        - name: user_username_present
          field: username
          is_not_empty: true

  /api/v1/auth/me:
    GET:
      invariants:
        # Authenticated user must be active
        - name: current_user_active
          field: is_active
          equals: true

        # Date ordering
        - name: user_updated_after_created
          field: created_at
          less_than_or_equal: $.updated_at


  # ============================================================
  # LEGACY: Simple fault injection (still supported)
  # ============================================================
faults:
  null_field:
    enabled: true
  missing_field:
    enabled: true
  empty_list:
    enabled: false
  empty_string:
    enabled: false

